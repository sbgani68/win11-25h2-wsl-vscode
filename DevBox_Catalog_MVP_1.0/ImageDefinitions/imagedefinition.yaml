$schema: "1.0"
name: "Win11-24H2-Ent-M365-WSL2-Ubuntu"
image: "microsoftwindowsdesktop_windows-ent-cpc_win11-24h2-ent-cpc-m365"

tasks:
  - name: ~/winget
    parameters:
      package: Git.Git
  - name: ~/winget
    parameters:
      package: Microsoft.VisualStudioCode
  - name: ~/winget
    parameters:
      package: Docker.DockerDesktop
  - name: ~/winget
    parameters:
      package: Microsoft.WindowsTerminal
  - name: ~/winget
    parameters:
      package: SlackTechnologies.Slack

  - name: ~/powershell
    parameters:
      command: |
        $LogRoot = 'C:\\ProgramData\\DevBox\\JS Build logs'
        New-Item -Path $LogRoot -ItemType Directory -Force | Out-Null
        $TaskName = '02_Enable_WSL'
        $Transcript = Join-Path $LogRoot ("{0}_{1}.log" -f $TaskName, (Get-Date -Format "yyyy-MM-dd_HH-mm-ss"))
        function Write-Log([string]$msg) { "{0} - {1}" -f (Get-Date -Format "o"), $msg | Tee-Object -FilePath $Transcript -Append | Out-Null }
        try {
          Start-Transcript -Path $Transcript -Force | Out-Null
          Write-Log "Starting task: $TaskName"
          $features = @("Microsoft-Windows-Subsystem-Linux","VirtualMachinePlatform")
          $changed = $false
          foreach ($f in $features) {
            $state = (Get-WindowsOptionalFeature -Online -FeatureName $f).State
            Write-Log "Feature $f state: $state"
            if ($state -ne "Enabled") {
              Enable-WindowsOptionalFeature -Online -FeatureName $f -NoRestart | Out-Null
              Write-Log "Enabled feature: $f (NoRestart)"
              $changed = $true
            }
          }
          wsl.exe --set-default-version 2
          Write-Log "Set WSL default version to 2"
          if ($changed) { Write-Log "WSL features changed; Windows may require a reboot. Platform will handle if needed." } else { Write-Log "WSL features already enabled." }
          Write-Log "Completed task: $TaskName (success)"
        } catch { Write-Log "ERROR in $TaskName: $_"; throw } finally { Stop-Transcript | Out-Null }

  - name: ~/powershell
    parameters:
      command: |
        $LogRoot = 'C:\\ProgramData\\DevBox\\JS Build logs'
        New-Item -Path $LogRoot -ItemType Directory -Force | Out-Null
        $TaskName = '03_Install_Ubuntu2204'
        $Transcript = Join-Path $LogRoot ("{0}_{1}.log" -f $TaskName, (Get-Date -Format "yyyy-MM-dd_HH-mm-ss"))
        function Write-Log([string]$msg) { "{0} - {1}" -f (Get-Date -Format "o"), $msg | Tee-Object -FilePath $Transcript -Append | Out-Null }
        try {
          Start-Transcript -Path $Transcript -Force | Out-Null
          Write-Log "Starting task: $TaskName"
          $ubuntuName = "Ubuntu-22.04"
          $installed = & wsl.exe -l -q 2>$null | ForEach-Object { $_.Trim() } | Where-Object { $_ -eq $ubuntuName }
          if (-not $installed) { Write-Log "Installing $ubuntuName..."; wsl.exe --install -d $ubuntuName; Write-Log "Install command issued for $ubuntuName" } else { Write-Log "$ubuntuName already installed. Skipping." }
          Write-Log "WSL status:"; (wsl.exe --status) | ForEach-Object { Write-Log $_ }
          Write-Log "Completed task: $TaskName (success)"
        } catch { Write-Log "ERROR in $TaskName: $_"; throw } finally { Stop-Transcript | Out-Null }

  - name: ~/powershell
    parameters:
      command: |
        $LogRoot = 'C:\\ProgramData\\DevBox\\JS Build logs'
        New-Item -Path $LogRoot -ItemType Directory -Force | Out-Null
        $TaskName = '04_UAC_Policy'
        $Transcript = Join-Path $LogRoot ("{0}_{1}.log" -f $TaskName, (Get-Date -Format "yyyy-MM-dd_HH-mm-ss"))
        function Write-Log([string]$msg) { "{0} - {1}" -f (Get-Date -Format "o"), $msg | Tee-Object -FilePath $Transcript -Append | Out-Null }
        try {
          Start-Transcript -Path $Transcript -Force | Out-Null
          Write-Log "Starting task: $TaskName"
          $sys = 'HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System'
          $c = (Get-ItemProperty -Path $sys -Name 'ConsentPromptBehaviorAdmin' -ErrorAction SilentlyContinue).ConsentPromptBehaviorAdmin
          $p = (Get-ItemProperty -Path $sys -Name 'PromptOnSecureDesktop' -ErrorAction SilentlyContinue).PromptOnSecureDesktop
          Write-Log "Current UAC values: ConsentPromptBehaviorAdmin=$c, PromptOnSecureDesktop=$p"
          $changed = $false
          if ($c -ne 0) { Set-ItemProperty -Path $sys -Name 'ConsentPromptBehaviorAdmin' -Type DWord -Value 0 -Force; Write-Log "Set ConsentPromptBehaviorAdmin=0"; $changed = $true }
          if ($p -ne 0) { Set-ItemProperty -Path $sys -Name 'PromptOnSecureDesktop' -Type DWord -Value 0 -Force; Write-Log "Set PromptOnSecureDesktop=0"; $changed = $true }
          if ($changed) { Write-Log "UAC policy changed." } else { Write-Log "UAC policy already in desired state." }
          Write-Log "Completed task: $TaskName (success)"
        } catch { Write-Log "ERROR in $TaskName: $_"; throw } finally { Stop-Transcript | Out-Null }

  - name: ~/powershell
    parameters:
      command: |
        $LogRoot = 'C:\\ProgramData\\DevBox\\JS Build logs'
        New-Item -Path $LogRoot -ItemType Directory -Force | Out-Null
        $TaskName = '05_Unpin_MS_Store'
        $Transcript = Join-Path $LogRoot ("{0}_{1}.log" -f $TaskName, (Get-Date -Format "yyyy-MM-dd_HH-mm-ss"))
        function Write-Log([string]$msg) { "{0} - {1}" -f (Get-Date -Format "o"), $msg | Tee-Object -FilePath $Transcript -Append | Out-Null }
        try {
          Start-Transcript -Path $Transcript -Force | Out-Null
          Write-Log "Starting task: $TaskName"
          $paths = @(
            "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\System Tools\Windows Store.lnk",
            "$env:APPDATA\Microsoft\Internet Explorer\Quick Launch\User Pinned\TaskBar\Microsoft.Store.lnk"
          )
          foreach ($p in $paths) {
            if (Test-Path $p) { try { Remove-Item -Path $p -ErrorAction Stop; Write-Log "Removed shortcut: $p" } catch { Write-Log "WARN: Could not remove $p: $_" } }
            else { Write-Log "Shortcut not found (already removed): $p" }
          }
          Write-Log "Completed task: $TaskName (success)"
        } catch { Write-Log "ERROR in $TaskName: $_"; throw } finally { Stop-Transcript | Out-Null }

userTasks:
  - name: ~/powershell
    parameters:
      command: |
        $LogRoot = 'C:\\ProgramData\\DevBox\\JS Build logs'
        New-Item -Path $LogRoot -ItemType Directory -Force | Out-Null
        $TaskName = '99_User_Validation'
        $Transcript = Join-Path $LogRoot ("{0}_{1}.log" -f $TaskName, (Get-Date -Format "yyyy-MM-dd_HH-mm-ss"))
        function Write-Log([string]$msg) { "{0} - {1}" -f (Get-Date -Format "o"), $msg | Tee-Object -FilePath $Transcript -Append | Out-Null }
        try {
          Start-Transcript -Path $Transcript -Force | Out-Null
          Write-Log "Starting user validation"
          Write-Log "WSL distros:"; (wsl.exe -l -v) | ForEach-Object { Write-Log $_ }
          Write-Log "Git version:"; (git --version) | ForEach-Object { Write-Log $_ }
          Write-Log "VS Code version:"; (code --version) | ForEach-Object { Write-Log $_ }
          Write-Log "Docker version:"; (docker --version) | ForEach-Object { Write-Log $_ }
          Write-Log "Completed user validation (success)"
        } catch { Write-Log "ERROR in user validation: $_"; throw } finally { Stop-Transcript | Out-Null }
